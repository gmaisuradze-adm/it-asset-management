@model HospitalAssetTracker.Models.Asset
@{
    ViewData["Title"] = "Asset Details";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Asset Details</h1>
    <div class="btn-group" role="group">
        @if (User.IsInRole("Admin") || User.IsInRole("IT Support") || User.IsInRole("Asset Manager"))
        {
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#moveModal">
                <i class="bi bi-arrow-right-square"></i> Move
            </button>
            <form asp-action="Clone" method="post" class="d-inline">
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-info" onclick="return confirm('Clone this asset?')">
                    <i class="bi bi-files"></i> Clone
                </button>
            </form>
            @if (Model.Status != HospitalAssetTracker.Models.AssetStatus.WriteOff && Model.Status != HospitalAssetTracker.Models.AssetStatus.Decommissioned)
            {
                <a asp-controller="WriteOff" asp-action="Create" asp-route-assetId="@Model.Id" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Request Write-Off
                </a>
            }
        }
        <a asp-action="QRCode" asp-route-id="@Model.Id" class="btn btn-outline-primary" target="_blank">
            <i class="bi bi-qr-code"></i> QR Code
        </a>
    </div>
</div>

<!-- Status Alert -->
@switch (Model.Status)
{
    case HospitalAssetTracker.Models.AssetStatus.UnderRepair:
        <div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> This asset is currently under repair.</div>
        break;
    case HospitalAssetTracker.Models.AssetStatus.Decommissioned:
        <div class="alert alert-danger"><i class="bi bi-x-circle"></i> This asset has been decommissioned.</div>
        break;
    case HospitalAssetTracker.Models.AssetStatus.WriteOff:
        <div class="alert alert-danger"><i class="bi bi-x-circle"></i> This asset has been written off.</div>
        break;
}

<div class="row">
    <!-- Basic Information -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Basic Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Asset Tag:</strong><br>
                        <span class="fs-4 text-primary">@Model.AssetTag</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Internal Serial:</strong><br>
                        <code>@(Model.InternalSerialNumber ?? "Not Generated")</code>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Category:</strong><br>
                        <span class="badge bg-secondary fs-6">@Model.Category</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong><br>
                        @switch (Model.Status)
                        {
                            case HospitalAssetTracker.Models.AssetStatus.InUse:
                                <span class="badge bg-success fs-6">In Use</span>
                                break;
                            case HospitalAssetTracker.Models.AssetStatus.Available:
                                <span class="badge bg-primary fs-6">Available</span>
                                break;
                            case HospitalAssetTracker.Models.AssetStatus.UnderRepair:
                                <span class="badge bg-warning fs-6">Under Repair</span>
                                break;
                            case HospitalAssetTracker.Models.AssetStatus.Decommissioned:
                                <span class="badge bg-danger fs-6">Decommissioned</span>
                                break;
                            default:
                                <span class="badge bg-secondary fs-6">@Model.Status</span>
                                break;
                        }
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <strong>Brand:</strong><br>
                        @Model.Brand
                    </div>
                    <div class="col-md-4">
                        <strong>Model:</strong><br>
                        @Model.Model
                    </div>
                    <div class="col-md-4">
                        <strong>Serial Number:</strong><br>
                        @(Model.SerialNumber ?? "N/A")
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <hr>
                    <strong>Description:</strong><br>
                    @Model.Description
                }
            </div>
        </div>

        <!-- Location & Assignment -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-geo-alt"></i> Location & Assignment</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Location:</strong><br>
                        @if (Model.Location != null)
                        {
                            <span class="text-primary">@Model.Location.FullLocation</span>
                        }
                        else
                        {
                            <span class="text-muted">Unassigned</span>
                        }
                    </div>
                    <div class="col-md-6">
                        <strong>Assigned To:</strong><br>
                        @if (Model.AssignedToUser != null)
                        {
                            <span class="text-primary">@Model.AssignedToUser.FullName</span>
                        }
                        else
                        {
                            <span class="text-muted">Unassigned</span>
                        }
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.ResponsiblePerson))
                {
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Responsible Person:</strong><br>
                            @Model.ResponsiblePerson
                        </div>
                        <div class="col-md-6">
                            <strong>Department:</strong><br>
                            @(Model.Department ?? "N/A")
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Purchase & Warranty -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-receipt"></i> Purchase & Warranty Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Installation Date:</strong><br>
                        @Model.InstallationDate.ToString("dd/MM/yyyy")
                    </div>
                    <div class="col-md-6">
                        <strong>Warranty Expiry:</strong><br>
                        @if (Model.WarrantyExpiry.HasValue)
                        {
                            var isExpired = Model.WarrantyExpiry.Value < DateTime.UtcNow;
                            <span class="@(isExpired ? "text-danger" : "text-success")">
                                @Model.WarrantyExpiry.Value.ToString("dd/MM/yyyy")
                                @if (isExpired)
                                {
                                    <i class="bi bi-exclamation-triangle"></i>
                                }
                            </span>
                        }
                        else
                        {
                            <span class="text-muted">N/A</span>
                        }
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Supplier:</strong><br>
                        @(Model.Supplier ?? "N/A")
                    </div>
                    <div class="col-md-6">
                        <strong>Purchase Price:</strong><br>
                        @if (Model.PurchasePrice.HasValue)
                        {
                            <span class="text-success">@Model.PurchasePrice.Value.ToString("C")</span>
                        }
                        else
                        {
                            <span class="text-muted">N/A</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents & Images -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-file-earmark"></i> Documents & Images</h5>
            </div>
            <div class="card-body">
                @if (User.IsInRole("Admin") || User.IsInRole("IT Support") || User.IsInRole("Asset Manager"))
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <form asp-action="UploadDocument" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="assetId" value="@Model.Id" />
                                <div class="input-group">
                                    <input type="file" class="form-control" name="document" required />
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="bi bi-upload"></i> Upload Document
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <form asp-action="UploadImage" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="assetId" value="@Model.Id" />
                                <div class="input-group">
                                    <input type="file" class="form-control" name="image" accept="image/*" required />
                                    <button type="submit" class="btn btn-outline-success">
                                        <i class="bi bi-image"></i> Upload Image
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                
                <!-- Document Lists would go here when implemented -->
                <p class="text-muted">
                    <i class="bi bi-info-circle"></i> Document and image management will be displayed here.
                </p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Quick Actions -->
        @if (User.IsInRole("Admin") || User.IsInRole("IT Support") || User.IsInRole("Asset Manager"))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#statusModal">
                            <i class="bi bi-arrow-repeat"></i> Change Status
                        </button>
                        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#maintenanceModal">
                            <i class="bi bi-tools"></i> Schedule Maintenance
                        </button>
                        @if (User.IsInRole("Admin") || User.IsInRole("Asset Manager"))
                        {
                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#decommissionModal">
                                <i class="bi bi-x-circle"></i> Decommission
                            </button>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- QR Code -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-qr-code"></i> QR Code</h5>
            </div>
            <div class="card-body text-center">
                <img src="@Url.Action("QRCode", new { id = Model.Id })" alt="QR Code" class="img-fluid mb-2" style="max-width: 200px;" />
                <br>
                <small class="text-muted">Scan for quick access</small>
            </div>
        </div>

        <!-- System Information -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock"></i> System Information</h5>
            </div>
            <div class="card-body">
                <small>
                    <strong>Created:</strong><br>
                    @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")<br><br>
                    <strong>Last Updated:</strong><br>
                    @Model.LastUpdated.ToString("dd/MM/yyyy HH:mm")
                </small>
                @if (!string.IsNullOrEmpty(Model.Notes))
                {
                    <hr>
                    <strong>Notes:</strong><br>
                    <small>@Model.Notes</small>
                }
            </div>
        </div>
    </div>
</div>

<!-- Movement History -->
<div class="card mt-4">
    <div class="card-header">
        <h5><i class="bi bi-clock-history"></i> Movement History</h5>
    </div>
    <div class="card-body">
        @if (ViewBag.Movements != null && ((IEnumerable<HospitalAssetTracker.Models.AssetMovement>)ViewBag.Movements).Any())
        {
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Performed By</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.Movements != null)
                        {
                            @foreach (var movement in (IEnumerable<HospitalAssetTracker.Models.AssetMovement>)ViewBag.Movements)
                            {
                                <tr>
                                    <td>@movement.MovementDate.ToString("dd/MM/yyyy")</td>
                                    <td>@movement.MovementType</td>
                                    <td>@(movement.FromLocation?.FullLocation ?? movement.FromUser?.FullName ?? "N/A")</td>
                                    <td>@(movement.ToLocation?.FullLocation ?? movement.ToUser?.FullName ?? "N/A")</td>
                                    <td>@(movement.PerformedByUser?.FullName ?? "System")</td>
                                    <td>@(movement.Reason ?? "N/A")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted">No movement history available</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-muted text-center py-4">
                <i class="bi bi-inbox"></i><br>
                No movement history available for this asset.
            </p>
        }
    </div>
</div>

<!-- Modals -->
<!-- Move Modal -->
<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Move" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Move Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">New Location</label>
                        <select name="newLocationId" class="form-select">
                            <option value="">Select Location</option>
                            @if (ViewBag.Locations != null)
                            {
                                @foreach (var location in ViewBag.Locations)
                                {
                                    <option value="@location.Value">@location.Text</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign To User</label>
                        <select name="newUserId" class="form-select">
                            <option value="">Select User</option>
                            @if (ViewBag.Users != null)
                            {
                                @foreach (var user in ViewBag.Users)
                                {
                                    <option value="@user.Value">@user.Text</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason *</label>
                        <textarea name="reason" class="form-control" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="ChangeStatus" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Change Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select name="newStatus" class="form-select" required>
                            <option value="">Select Status</option>
                            <option value="0">In Use</option>
                            <option value="1">Available</option>
                            <option value="2">Under Repair</option>
                            <option value="3">Maintenance</option>
                            <option value="4">Reserved</option>
                            <option value="5">Upgraded</option>
                            <option value="6">Decommissioned</option>
                            <option value="7">Write Off</option>
                            <option value="8">Lost</option>
                            <option value="9">Stolen</option>
                            <option value="10">Pending Approval</option>
                            <option value="11">In Transit</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason *</label>
                        <textarea name="reason" class="form-control" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Change Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Decommission Modal -->
<div class="modal fade" id="decommissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Decommission" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Decommission Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action will mark the asset as decommissioned and remove it from active use.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason for Decommission *</label>
                        <textarea name="reason" class="form-control" rows="3" required placeholder="Please provide a detailed reason for decommissioning this asset..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Decommission Asset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="mt-4">
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Assets
    </a>
    <a asp-action="History" asp-route-id="@Model.Id" class="btn btn-outline-info">
        <i class="bi bi-clock-history"></i> Full History
    </a>
</div>
